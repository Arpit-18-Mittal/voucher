package grafeas

import (
	"strings"

	"github.com/Shopify/voucher"
	containeranalysispb "google.golang.org/genproto/googleapis/devtools/containeranalysis/v1alpha1"
)

// vulProject is the project that Google's Container Analysis writes vulnerability
// occurrences to.
const vulProject = "projects/goog-vulnz/notes/"

// getSeverity translates the Google Container Analysis Severity to a Voucher Severity.
func getSeverity(severity string) voucher.Severity {
	switch severity {
	case "MINIMAL":
		return voucher.NegligibleSeverity
	case "LOW":
		return voucher.LowSeverity
	case "MEDIUM":
		return voucher.MediumSeverity
	case "HIGH":
		return voucher.HighSeverity
	case "CRITICAL":
		return voucher.CriticalSeverity
	}
	return voucher.UnknownSeverity
}

// OccurrenceToVulnerability converts an Occurrence to a Vulnerability.
func OccurrenceToVulnerability(occ voucher.Occurrence) (vul voucher.Vulnerability) {
	vul.Name = strings.Replace(occ.GetNoteName(), vulProject, "", 1)
	vulnDetails := occ.GetDetails().(*containeranalysispb.Occurrence_VulnerabilityDetails).VulnerabilityDetails
	vul.Severity = getSeverity(containeranalysispb.VulnerabilityType_Severity_name[int32(vulnDetails.Severity)])

	return
}
